<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÅ‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô Early Ambulate ‡πÅ‡∏•‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏Å‡∏≤‡∏£ | Responsive App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#1e40af', // Blue-800
                        'secondary': '#6b7280', // Gray-500
                        'accent': '#f59e0b', // Amber-500
                        'danger': '#dc2626', // Red-600
                        'success': '#10b981', // Green-500
                    },
                }
            }
        }
    </script>
    <style>
        @media print {
            body { margin: 0; padding: 0; }
            @page { margin: 1cm; }
            /* ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå */
            .no-print { display: none !important; }
        }
    </style>
</head>
<body>

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const { createRoot } = ReactDOM;

        // --- ICON COMPONENTS (‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á) ---
        const IconComponent = ({ name, className = "w-6 h-6 text-gray-800" }) => {
            const icons = {
                CheckSquare: <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M9 12l2 2l4 -4"/></svg>,
                Square: <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="3" rx="2"/></svg>,
                Clock: <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 8v4l3 3"/></svg>,
                FileText: <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7l-5-5z"/><path d="M10 12h4"/><path d="M10 16h4"/><path d="M10 8h4"/></svg>,
                AlertCircle: <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>,
                Download: <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>,
                User: <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
                Scissors: <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="6" cy="6" r="3"/><circle cx="6" cy="18" r="3"/><line x1="20" y1="4" x2="8.12" y2="15.88"/><line x1="14.47" y1="14.48" x2="20" y2="20"/><line x1="8.12" y1="8.12" x2="12" y2="12"/></svg>,
                Save: <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>,
                Trash2: <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>,
                Search: <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>,
                Edit: <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 3a2.85 2.85 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>,
                Thermometer: <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14 4V2a2 2 0 0 0-4 0v2h4z"/><path d="M12 22a4 4 0 0 0 4-4V6a4 4 0 0 0-8 0v12a4 4 0 0 0 4 4z"/><line x1="12" y1="14" x2="12" y2="18"/></svg>,
                Calendar: <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>,
                RefreshCw: <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-7.2 3.1L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 7.2-3.1L21 16"/><path d="M21 21v-5h-5"/></svg>,
            };
            return icons[name] || <span>{name}</span>;
        };
        const { CheckSquare, Square, Clock, FileText, AlertCircle, Download, User, Scissors, Save, Trash2, Search, Edit, Thermometer, Calendar, RefreshCw } = {
            CheckSquare: (props) => <IconComponent name="CheckSquare" {...props} />,
            Square: (props) => <IconComponent name="Square" {...props} />,
            Clock: (props) => <IconComponent name="Clock" {...props} />,
            FileText: (props) => <IconComponent name="FileText" {...props} />,
            AlertCircle: (props) => <IconComponent name="AlertCircle" {...props} />,
            Download: (props) => <IconComponent name="Download" {...props} />,
            User: (props) => <IconComponent name="User" {...props} />,
            Scissors: (props) => <IconComponent name="Scissors" {...props} />,
            Save: (props) => <IconComponent name="Save" {...props} />,
            Trash2: (props) => <IconComponent name="Trash2" {...props} />,
            Search: (props) => <IconComponent name="Search" {...props} />,
            Edit: (props) => <IconComponent name="Edit" {...props} />,
            Thermometer: (props) => <IconComponent name="Thermometer" {...props} />,
            Calendar: (props) => <IconComponent name="Calendar" {...props} />,
            RefreshCw: (props) => <IconComponent name="RefreshCw" {...props} />,
        };


        // --- GOOGLE APPS SCRIPT URL (***‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô URL ‡∏ô‡∏µ‡πâ‡∏î‡πâ‡∏ß‡∏¢ Web App URL ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î***) ---
        // ***‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏ï‡πâ‡∏≠‡∏á Deploy Apps Script ‡∏ï‡∏≤‡∏°‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡πÉ‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 3 ‡∏Å‡πà‡∏≠‡∏ô***
        const GOOGLE_SHEET_URL = "YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL"; 

        const initialPatientState = { firstName: '', lastName: '', an: '', surgeryType: '', surgeryDate: '', dischargeDate: '' }; 
        const initialComplicationState = { DVT: false, Atelectasis: false, Constipation: false, OtherSymptoms: '' };
        
        // --- Component: Custom Alert Message ---
        const Alert = ({ message, type, onClose }) => {
            const colors = {
                success: 'bg-success border-success-400 text-white',
                error: 'bg-danger border-danger-400 text-white',
                warning: 'bg-accent border-accent-400 text-white',
            };

            if (!message) return null;

            return (
                <div 
                    className={`fixed top-4 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-xl shadow-2xl z-50 transition-opacity duration-300 flex items-center gap-3 ${colors[type]}`}
                    role="alert"
                >
                    <IconComponent name={type === 'success' ? 'CheckSquare' : 'AlertCircle'} className="w-6 h-6" />
                    <span className="font-semibold">{message}</span>
                    <button onClick={onClose} className="ml-4 text-white/80 hover:text-white font-bold">√ó</button>
                </div>
            );
        };

        // --- ‡πÇ‡∏Ñ‡πâ‡∏î React Component ‡∏´‡∏•‡∏±‡∏Å ---
        function AmbulateAssessment() {
            const [selectedDay, setSelectedDay] = useState('admission');
            const [checkedItems, setCheckedItems] = useState({});
            const [patientInfo, setPatientInfo] = useState(initialPatientState);
            const [complications, setComplications] = useState(initialComplicationState);
            const [savedPatients, setSavedPatients] = useState({}); // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å Sheet
            const [alertState, setAlertState] = useState({ message: '', type: '', key: 0 });
            const [isLoading, setIsLoading] = useState(false);


            // --- Function: ‡πÅ‡∏™‡∏î‡∏á Alert ---
            const showAlert = (message, type = 'success') => {
                setAlertState({ message, type, key: Date.now() });
                setTimeout(() => setAlertState({ message: '', type: '', key: 0 }), 5000);
            };

            // --- Function: ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å Google Sheet ---
            const fetchPatientsFromSheet = async () => {
                if (GOOGLE_SHEET_URL === "YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL") {
                    showAlert("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô GOOGLE_SHEET_URL ‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡∏Å‡πà‡∏≠‡∏ô!", 'warning');
                    return; 
                }
                setIsLoading(true);
                try {
                    const response = await fetch(GOOGLE_SHEET_URL + "?action=getAll", { method: 'GET', mode: 'cors' });
                    const result = await response.json();
                    
                    if (result.result === "success") {
                        // result.data ‡∏Ñ‡∏∑‡∏≠ Object ‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ { 'AN': { info, checks, complications } }
                        setSavedPatients(result.data);
                        showAlert(`‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${Object.keys(result.data).length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`, 'success');
                    } else {
                        showAlert(`‚ùå Error: ${result.message || "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Sheet"}`, 'error');
                        console.error("Error fetching patients from Sheet:", result);
                    }
                } catch (error) {
                    showAlert(`‚ùå Error: ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Apps Script ‡πÑ‡∏î‡πâ (${error.message})`, 'error');
                    console.error("Error connecting to Google Sheet for fetch:", error);
                } finally {
                    setIsLoading(false);
                }
            };
            
            // --- Function: ‡πÇ‡∏´‡∏•‡∏î‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ---
            const loadPatient = (patientKey) => {
                const patientData = savedPatients[patientKey];
                if (patientData) {
                    if (window.confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢: ${patientData.info.firstName} ${patientData.info.lastName} (AN: ${patientKey}) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà!`)) {
                        
                        const loadedInfo = { ...initialPatientState, ...patientData.info };
                        const loadedComplications = { ...initialComplicationState, ...patientData.complications };

                        setPatientInfo(loadedInfo);
                        setCheckedItems(patientData.checks);
                        setComplications(loadedComplications);
                        setSelectedDay('admission');
                        showAlert(`üìù ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ AN: ${patientKey} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`, 'success');
                    }
                }
            };

            // --- Function: ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏•‡∏ö‡πÑ‡∏õ‡∏¢‡∏±‡∏á Apps Script) ---
            const deletePatient = async (patientKey, patientName) => {
                if (window.confirm(`‚ö†Ô∏è ‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢: ${patientName} (AN: ${patientKey})? ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å Google Sheet ‡∏ñ‡∏≤‡∏ß‡∏£!`)) {
                    setIsLoading(true);
                    try {
                        const response = await fetch(GOOGLE_SHEET_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ action: 'deletePatient', an: patientKey })
                        });
                        const result = await response.json();

                        if (result.result === "success") {
                            // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏•‡∏ö
                            await fetchPatientsFromSheet(); 
                            showAlert(`üóëÔ∏è ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ AN: ${patientKey} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`, 'success');

                            // ‡∏´‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô ‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£ Reset Form
                            if (patientInfo.an === patientKey) {
                                resetAssessment(false);
                            }
                        } else {
                            showAlert(`‚ùå ‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! Error: ${result.message}`, 'error');
                        }
                    } catch (error) {
                        showAlert(`‚ùå Error: ${error.message}`, 'error');
                    } finally {
                        setIsLoading(false);
                    }
                }
            };
            
            // --- Function: ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ Apps Script (Save/Update) ---
            const sendToGoogleSheet = async (data) => {
                if (GOOGLE_SHEET_URL === "YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL") {
                    showAlert("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô GOOGLE_SHEET_URL ‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡∏Å‡πà‡∏≠‡∏ô!", 'warning');
                    return { isSent: false }; 
                }
                
                try {
                    const response = await fetch(GOOGLE_SHEET_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: 'savePatient', data: data })
                    });
                    const result = await response.json();
                    
                    if (result.result === "success") {
                        return { isSent: true, message: result.message };
                    } else {
                        return { isSent: false, message: result.message || "Failed to send data." };
                    }
                } catch (error) {
                    return { isSent: false, message: error.toString() };
                }
            };

            // --- Function: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô ---
            const saveCurrentPatient = async () => {
                if (!isFormValid) {
                    showAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å ‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• ‡πÅ‡∏•‡∏∞ AN ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å!', 'warning');
                    return;
                }
                setIsLoading(true);
                const patientDataToSave = {
                    info: patientInfo,
                    checks: checkedItems,
                    complications: complications,
                    lastUpdate: new Date().toISOString()
                };

                const { isSent, message } = await sendToGoogleSheet(patientDataToSave);

                if (isSent) {
                    // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÉ‡∏´‡πâ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å Sheet ‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏´‡∏°‡πà (Re-synchronize)
                    await fetchPatientsFromSheet();
                    showAlert(`‚úÖ ${message} ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ AN: ${patientInfo.an} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!`, 'success');
                } else {
                    showAlert(`‚ùå ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏¢‡∏±‡∏á Google Sheet ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß! Error: ${message}`, 'error');
                }
                setIsLoading(false);
            };
            
            // --- Function: ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô ---
            const resetAssessment = (confirmUser = true) => {
                if (confirmUser && !window.confirm("‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô?")) return;
                
                setPatientInfo(initialPatientState);
                setCheckedItems({});
                setComplications(initialComplicationState);
                setSelectedDay('admission');
                if (confirmUser) showAlert('‚ú® ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏ñ‡∏π‡∏Å‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß!', 'success');
            };

            // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠ Component ‡∏ñ‡∏π‡∏Å‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
            useEffect(() => {
                fetchPatientsFromSheet();
            }, []);

            // --- Data & Logic For Rendering ---

            const assessmentData = {
                admission: { title: 'Admission Day', subtitle: '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î', color: 'from-pink-500 to-pink-600', items: [{ id: 'a1', text: '‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ù‡∏∂‡∏Å Ambulate' }, { id: 'a2', text: '‡∏û‡∏•‡∏¥‡∏Å‡∏ï‡∏∞‡πÅ‡∏Ñ‡∏á‡∏ï‡∏±‡∏ß‡∏ã‡πâ‡∏≤‡∏¢ ‡∏Ç‡∏ß‡∏≤ ‡∏ó‡∏∏‡∏Å 2 ‡∏ä‡∏°.' }, { id: 'a3', text: '‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡πà‡∏á‡∏´‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏á‡∏ó‡∏±‡πâ‡∏á ‡∏´‡∏±‡∏ß‡πÄ‡∏ï‡∏µ‡∏¢‡∏á‡∏®‡∏µ‡∏£‡∏©‡∏∞‡∏™‡∏π‡∏á 30-45 ‡∏≠‡∏á‡∏®‡∏≤ ‡∏ô‡∏≤‡∏ô 15 ‡∏ô‡∏≤‡∏ó‡∏µ' }, { id: 'a4', text: '‡∏Å‡∏≤‡∏£‡∏ï‡∏∞‡πÅ‡∏Ñ‡∏á‡∏ï‡∏±‡∏ß‡∏•‡∏∏‡∏Å‡∏ô‡∏±‡πà‡∏á ‡∏ö‡∏ô‡πÄ‡∏ï‡∏µ‡∏¢‡∏á‡πÑ‡∏°‡πà‡∏û‡∏∂‡πà‡∏á‡∏´‡∏±‡∏ß‡πÄ‡∏ï‡∏µ‡∏¢‡∏á ‡πÅ‡∏•‡∏∞‡πÅ‡∏Å‡∏ß‡πà‡∏á‡∏Ç‡∏≤‡∏Ç‡πâ‡∏≤‡∏á‡πÄ‡∏ï‡∏µ‡∏¢‡∏á ‡∏ô‡∏≤‡∏ô 5 ‡∏ô‡∏≤‡∏ó‡∏µ' }, { id: 'a5', text: '‡∏¢‡∏∑‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡πÄ‡∏ï‡∏µ‡∏¢‡∏á ‡∏¢‡∏∑‡∏ô‡∏ó‡πâ‡∏≤ ‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà 10 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏Å‡πà‡∏≠‡∏ô‡∏•‡∏∏‡∏Å‡πÄ‡∏î‡∏¥‡∏ô' }, { id: 'a6', text: '‡∏•‡∏∏‡∏Å‡πÄ‡∏î‡∏¥‡∏ô' }] },
                surgery: { title: '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î', subtitle: '‡∏ï‡∏≤‡∏°‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏™‡∏±‡πà‡∏á', color: 'from-blue-500 to-blue-600', items: [{ id: 's1', text: '‡∏´‡∏•‡∏±‡∏á‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏≠‡∏≠‡∏Å ‡∏à‡∏≤‡∏Å OR' }, { id: 's2', text: '‡∏û‡∏•‡∏¥‡∏Å‡∏ï‡∏∞‡πÅ‡∏Ñ‡∏á‡∏ï‡∏±‡∏ß‡∏ã‡πâ‡∏≤‡∏¢ ‡∏Ç‡∏ß‡∏≤ ‡∏ó‡∏∏‡∏Å 2 ‡∏ä‡∏°.' }, { id: 's3', text: '‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡πà‡∏á‡∏´‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏á‡∏ó‡∏±‡πâ‡∏á ‡∏´‡∏±‡∏ß‡πÄ‡∏ï‡∏µ‡∏¢‡∏á‡∏®‡∏µ‡∏£‡∏©‡∏∞‡∏™‡∏π‡∏á 30-45 ‡∏≠‡∏á‡∏®‡∏≤ ‡∏ô‡∏≤‡∏ô 15 ‡∏ô‡∏≤‡∏ó‡∏µ 1 ‡∏£‡∏≠‡∏ö' }, { id: 's4', text: '‡∏Å‡∏≤‡∏£‡∏ï‡∏∞‡πÅ‡∏Ñ‡∏á‡∏ï‡∏±‡∏ß‡∏•‡∏∏‡∏Å ‡∏ô‡∏±‡πà‡∏á‡∏ö‡∏ô‡πÄ‡∏ï‡∏µ‡∏¢‡∏á‡πÑ‡∏°‡πà‡∏û‡∏∂‡πà‡∏á‡∏´‡∏±‡∏ß ‡πÄ‡∏ï‡∏µ‡∏¢‡∏á‡πÅ‡∏•‡∏∞‡πÅ‡∏Å‡∏ß‡πà‡∏á‡∏Ç‡∏≤‡∏Ç‡πâ‡∏≤‡∏á ‡πÄ‡∏ï‡∏µ‡∏¢‡∏á ‡∏ô‡∏≤‡∏ô 5 ‡∏ô‡∏≤‡∏ó‡∏µ' }] },
                postop1: { title: 'Post Op Day 1', subtitle: '‡∏ß‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î 1 ‡∏ß‡∏±‡∏ô', color: 'from-purple-500 to-purple-600', items: [{ id: 'p1', text: '‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡πà‡∏á‡πÅ‡∏Å‡∏ß‡πà‡∏á‡∏Ç‡∏≤‡∏Ç‡πâ‡∏≤‡∏á ‡πÄ‡∏ï‡∏µ‡∏¢‡∏á ‡∏ó‡πâ‡∏≤‡∏ô‡∏≤‡∏ô 5 ‡∏ô‡∏≤‡∏ó‡∏µ' }, { id: 'p2', text: '‡∏¢‡∏∑‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡πÄ‡∏ï‡∏µ‡∏¢‡∏á ‡∏¢‡∏∑‡∏ô‡∏ó‡πâ‡∏≤ ‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà 10 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏Å‡πà‡∏≠‡∏ô ‡∏•‡∏∏‡∏Å‡πÄ‡∏î‡∏¥‡∏ô' }, { id: 'p3', text: '‡∏•‡∏∏‡∏Å‡πÄ‡∏î‡∏¥‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏° ‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡πÅ‡∏•‡∏∞‡∏ç‡∏≤‡∏ï‡∏¥ ‡∏≠‡∏≠‡∏Å‡∏°‡∏≤‡∏ô‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á ‡∏•‡∏á ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏ó‡∏µ‡πà ‡πÄ‡∏î‡∏¥‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏°‡∏ï‡∏£ ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏•‡∏∞‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 40 ‡πÄ‡∏°‡∏ï‡∏£' }] },
                postop2: { title: 'Post Op Day 2 ‡∏ñ‡∏∂‡∏á Discharge', subtitle: '‡∏ß‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î 2 ‡∏ß‡∏±‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ', color: 'from-green-500 to-green-600', items: [{ id: 'd1', text: '‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡πà‡∏á‡πÅ‡∏Å‡∏ß‡πà‡∏á‡∏Ç‡∏≤‡∏Ç‡πâ‡∏≤‡∏á ‡πÄ‡∏ï‡∏µ‡∏¢‡∏á ‡∏ó‡πâ‡∏≤‡∏ô‡∏≤‡∏ô 5 ‡∏ô‡∏≤‡∏ó‡∏µ' }, { id: 'd2', text: '‡∏¢‡∏∑‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡πÄ‡∏ï‡∏µ‡∏¢‡∏á ‡∏¢‡∏∑‡∏ô‡∏ó‡πâ‡∏≤ ‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà 10 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏Å‡πà‡∏≠‡∏ô ‡∏•‡∏∏‡∏Å‡πÄ‡∏î‡∏¥‡∏ô' }, { id: 'd3', text: '‡∏•‡∏∏‡∏Å‡πÄ‡∏î‡∏¥‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏° ‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡πÅ‡∏•‡∏∞‡∏ç‡∏≤‡∏ï‡∏¥ ‡∏≠‡∏≠‡∏Å‡∏°‡∏≤‡∏ô‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á ‡∏•‡∏á ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏¥‡∏ô ‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏°‡∏ï‡∏£ ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏•‡∏∞ ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 60 ‡πÄ‡∏°‡∏ï‡∏£' }] }
            };

            const currentAssessment = assessmentData[selectedDay];
            const handleCheck = (itemId) => setCheckedItems(prev => ({ ...prev, [itemId]: !prev[itemId] }));
            const isFormValid = patientInfo.firstName && patientInfo.lastName && patientInfo.an;
            
            const handleComplicationCheck = (name) => {
                setComplications(prev => ({ ...prev, [name]: !prev[name] }));
            };

            const formatDateForReport = (dateString) => {
                if (!dateString) return '- ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏∞‡∏ö‡∏∏ -';
                try {
                    const date = new Date(dateString);
                    // ‡∏õ‡∏£‡∏±‡∏ö Timezone/Offset ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
                    date.setMinutes(date.getMinutes() + date.getTimezoneOffset());
                    return date.toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric'});
                } catch (e) {
                    return '- ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á -';
                }
            };
            
            // ‡πÉ‡∏ä‡πâ‡πÇ‡∏Ñ‡πâ‡∏î generatePDF ‡πÄ‡∏î‡∏¥‡∏° (‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏°‡∏≤‡∏Å‡∏ô‡∏±‡∏Å ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°‡∏î‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß)
            const generatePDF = () => {
                // ... (‡πÇ‡∏Ñ‡πâ‡∏î generatePDF ‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)
                const content = document.createElement('div');
                content.style.padding = '40px'; content.style.fontFamily = 'Arial, sans-serif'; content.style.maxWidth = '800px'; content.style.margin = '0 auto'; content.style.backgroundColor = 'white';

                const summaryHTML = Object.entries(assessmentData).map(([key, data]) => {
                    const total = data.items.length;
                    const checked = data.items.filter(item => checkedItems[item.id]).length;
                    const percentage = total > 0 ? Math.round((checked / total) * 100) : 0;
                    let colorClass = key === 'surgery' ? '#3b82f6' : (key === 'postop1' ? '#a855f7' : (key === 'postop2' ? '#10b981' : '#ec4899'));

                    return `
                        <div style="margin-bottom: 30px; page-break-inside: avoid;">
                            <div style="background: linear-gradient(to right, ${colorClass}, ${colorClass}); color: white; padding: 15px; border-radius: 10px 10px 0 0;">
                                <h2 style="margin: 0; font-size: 20px;">${data.title}</h2>
                                <p style="margin: 5px 0 0 0; opacity: 0.9; font-size: 14px;">${data.subtitle}</p>
                            </div>
                            <div style="border: 2px solid #e2e8f0; border-top: none; border-radius: 0 0 10px 10px; padding: 20px;">
                                <div style="background-color: #f8fafc; padding: 10px; border-radius: 5px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-weight: 600; color: #475569;">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤</span>
                                    <span style="font-weight: 700; color: ${colorClass}; font-size: 18px;">${checked}/${total} (${percentage}%)</span>
                                </div>
                                <table style="width: 100%; border-collapse: collapse;">
                                    ${data.items.map((item, index) => `<tr style="border-bottom: 1px solid #e2e8f0;"><td style="padding: 12px 8px; width: 60px; text-align: center;">${checkedItems[item.id] ? '<span style="color: #10b981; font-weight: bold;">‚úì</span>' : '‚òê'}</td><td style="padding: 12px 8px;"><span style="color: #334155;">${item.text}</span></td></tr>`).join('')}
                                </table>
                            </div>
                        </div>
                    `;
                }).join('');

                const complicationHTML = `
                    <h2 style="color: #ef4444; margin-top: 30px; margin-bottom: 15px; font-size: 20px; border-bottom: 2px solid #fca5a5; padding-bottom: 10px;">üî¥ ‡∏™‡∏£‡∏∏‡∏õ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏†‡∏≤‡∏ß‡∏∞‡πÅ‡∏ó‡∏£‡∏Å‡∏ã‡πâ‡∏≠‡∏ô (Immobility Complications)</h2>
                    <ul style="list-style: none; padding: 0;">
                        <li style="margin-bottom: 8px;"><span style="color: ${complications.DVT ? '#ef4444' : '#10b981'}; font-weight: bold;">${complications.DVT ? '‚ö†Ô∏è' : '‚úÖ'} DVT (‡∏•‡∏¥‡πà‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏≠‡∏∏‡∏î‡∏ï‡∏±‡∏ô):</span> ${complications.DVT ? '‡∏û‡∏ö' : '‡πÑ‡∏°‡πà‡∏û‡∏ö'}</li>
                        <li style="margin-bottom: 8px;"><span style="color: ${complications.Atelectasis ? '#ef4444' : '#10b981'}; font-weight: bold;">${complications.Atelectasis ? '‚ö†Ô∏è' : '‚úÖ'} ‡∏õ‡∏≠‡∏î‡πÅ‡∏ü‡∏ö/‡∏õ‡∏≠‡∏î‡∏≠‡∏±‡∏Å‡πÄ‡∏™‡∏ö:</span> ${complications.Atelectasis ? '‡∏û‡∏ö' : '‡πÑ‡∏°‡πà‡∏û‡∏ö'}</li>
                        <li style="margin-bottom: 8px;"><span style="color: ${complications.Constipation ? '#ef4444' : '#10b981'}; font-weight: bold;">${complications.Constipation ? '‚ö†Ô∏è' : '‚úÖ'} ‡∏ó‡πâ‡∏≠‡∏á‡∏ú‡∏π‡∏Å/‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Ç‡∏±‡∏ö‡∏ñ‡πà‡∏≤‡∏¢:</span> ${complications.Constipation ? '‡∏û‡∏ö' : '‡πÑ‡∏°‡πà‡∏û‡∏ö'}</li>
                        <li style="margin-bottom: 8px;"><span style="font-weight: bold;">‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏≠‡∏∑‡πà‡∏ô ‡πÜ:</span> ${complications.OtherSymptoms || '- ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏∞‡∏ö‡∏∏ -'}</li>
                    </ul>
                `;
                
                const surgeryDateText = formatDateForReport(patientInfo.surgeryDate);
                const dischargeDateText = formatDateForReport(patientInfo.dischargeDate);


                const totalItems = Object.values(assessmentData).reduce((sum, data) => sum + data.items.length, 0);
                const totalChecked = Object.values(assessmentData).reduce((sum, data) => sum + data.items.filter(item => checkedItems[item.id]).length, 0);
                const totalPercentage = totalItems > 0 ? Math.round((totalChecked / totalItems) * 100) : 0;

                content.innerHTML = `
                    <div style="text-align: center; margin-bottom: 30px; border-bottom: 3px solid #2563eb; padding-bottom: 20px;">
                        <h1 style="color: #1e40af; margin-bottom: 10px; font-size: 28px;">‡πÅ‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô Early Ambulate ‡πÅ‡∏•‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏Å‡∏≤‡∏£</h1>
                        <p style="color: #64748b; font-size: 14px;">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</p>
                    </div>
                    <div style="background-color: #f1f5f9; padding: 20px; border-radius: 10px; margin-bottom: 30px;">
                        <h2 style="color: #334155; margin-bottom: 15px; font-size: 18px; border-bottom: 2px solid #cbd5e1; padding-bottom: 10px;">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</h2>
                        <table style="width: 100%; border-collapse: collapse;">
                            <tr><td style="padding: 8px 0; color: #475569; font-weight: 600; width: 180px;">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•:</td><td style="padding: 8px 0; color: #1e293b;">${patientInfo.firstName} ${patientInfo.lastName}</td></tr>
                            <tr><td style="padding: 8px 0; color: #475569; font-weight: 600;">AN:</td><td style="padding: 8px 0; color: #1e293b;">${patientInfo.an}</td></tr>
                            <tr><td style="padding: 8px 0; color: #475569; font-weight: 600;">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î:</td><td style="padding: 8px 0; color: #1e293b;">${patientInfo.surgeryType || '- ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏∞‡∏ö‡∏∏ -'}</td></tr>
                            <tr><td style="padding: 8px 0; color: #475569; font-weight: 600;">‡∏ß‡∏±‡∏ô‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î:</td><td style="padding: 8px 0; color: #1e293b;">${surgeryDateText}</td></tr> 
                            <tr><td style="padding: 8px 0; color: #475569; font-weight: 600;">‡∏ß‡∏±‡∏ô‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢ (Discharge):</td><td style="padding: 8px 0; color: #1e293b;">${dischargeDateText}</td></tr> 
                            <tr><td style="padding: 8px 0; color: #475569; font-weight: 600;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô:</td><td style="padding: 8px 0; color: #1e293b;">${new Date().toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit'})}</td></tr>
                        </table>
                    </div>
                    ${complicationHTML}
                    ${summaryHTML}
                    <div style="background-color: #ecfdf5; border: 2px solid #10b981; border-radius: 10px; padding: 20px; margin-top: 30px;">
                        <h2 style="color: #065f46; margin-bottom: 15px; font-size: 20px;">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏£‡∏ß‡∏° (Early Ambulate Score)</h2>
                        <div style="text-align: center;">
                            <div style="font-size: 48px; font-weight: 700; color: #10b981; margin-bottom: 10px;">${totalChecked}/${totalItems}</div>
                            <div style="font-size: 24px; color: #047857;">${totalPercentage}% ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå</div>
                        </div>
                    </div>
                    <div style="margin-top: 40px; padding-top: 20px; border-top: 2px solid #e2e8f0; text-align: center; color: #64748b; font-size: 12px;">
                        <p>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏î‡∏¢‡∏£‡∏∞‡∏ö‡∏ö Early Ambulate Assessment</p>
                        <p>¬© ${new Date().getFullYear()} - ‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</p>
                    </div>
                `;

                const printWindow = window.open('', '_blank', 'width=800,height=600');
                printWindow.document.write(`<html><head><title>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô - ${patientInfo.firstName} ${patientInfo.lastName}</title><style>@media print { body { margin: 0; padding: 0; } @page { margin: 1cm; } } body { font-family: Arial, sans-serif; }</style></head><body>${content.innerHTML}</body></html>`);
                printWindow.document.close();
                setTimeout(() => { printWindow.focus(); printWindow.print(); }, 500);
            };

            // --- JSX/HTML Structure ---

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50 p-4">
                    <Alert message={alertState.message} type={alertState.type} onClose={() => setAlertState({ message: '', type: '', key: 0 })} key={alertState.key} />
                    {isLoading && (
                        <div className="fixed inset-0 bg-black/30 flex items-center justify-center z-40">
                            <div className="bg-white p-6 rounded-xl shadow-2xl flex items-center gap-3">
                                <RefreshCw className="w-6 h-6 animate-spin text-primary" />
                                <span className="text-primary font-semibold">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</span>
                            </div>
                        </div>
                    )}
                    <div className="max-w-4xl mx-auto">
                        
                        <div className="text-center mb-8 pt-8 no-print">
                            <div className="inline-flex items-center gap-3 mb-4">
                                <FileText className="w-10 h-10 text-primary" />
                                <h1 className="text-3xl font-extrabold text-gray-800">‡πÅ‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô Early Ambulate</h1>
                            </div>
                            <p className="text-secondary text-sm">‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢ React & Tailwind CSS</p>
                        </div>

                        {/* Patient Information Form */}
                        <div className="bg-white rounded-2xl shadow-2xl p-6 mb-6">
                            <div className="flex items-center gap-2 mb-4 border-b pb-3">
                                <User className="w-6 h-6 text-primary" />
                                <h2 className="text-xl font-bold text-gray-800">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</h2>
                            </div>
                            
                            {/* Row 1: Core Info */}
                            <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4"> 
                                <div className="md:col-span-2">
                                    <label className="block text-sm font-semibold text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• <span className="text-red-500">*</span></label>
                                    <div className="flex gap-2">
                                        <input type="text" value={patientInfo.firstName} onChange={(e) => setPatientInfo({...patientInfo, firstName: e.target.value})} placeholder="‡∏ä‡∏∑‡πà‡∏≠" className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-primary focus:outline-none transition-colors" />
                                        <input type="text" value={patientInfo.lastName} onChange={(e) => setPatientInfo({...patientInfo, lastName: e.target.value})} placeholder="‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-primary focus:outline-none transition-colors" />
                                    </div>
                                </div>
                                <div>
                                    <label className="block text-sm font-semibold text-gray-700 mb-2">AN <span className="text-red-500">*</span></label>
                                    <input type="text" value={patientInfo.an} onChange={(e) => setPatientInfo({...patientInfo, an: e.target.value})} placeholder="‡∏£‡∏∞‡∏ö‡∏∏ AN" className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-primary focus:outline-none transition-colors" />
                                </div>
                                <div>
                                    <label className="block text-sm font-semibold text-gray-700 mb-2">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î</label>
                                    <div className="relative">
                                        <input type="text" value={patientInfo.surgeryType} onChange={(e) => setPatientInfo({...patientInfo, surgeryType: e.target.value})} placeholder="‡πÄ‡∏ä‡πà‡∏ô TKR, THR, ACDF" className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-pink-500 focus:outline-none transition-colors pr-10" />
                                        <Scissors className="w-5 h-5 text-gray-400 absolute right-3 top-1/2 transform -translate-y-1/2" />
                                    </div>
                                </div>
                            </div>

                            {/* Row 2: Dates */}
                            <div className="grid grid-cols-1 md:grid-cols-4 gap-4"> 
                                <div className="md:col-span-2">
                                    <label className="block text-sm font-semibold text-gray-700 mb-2">‡∏ß‡∏±‡∏ô‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î</label>
                                    <div className="relative">
                                        <input 
                                            type="date" 
                                            value={patientInfo.surgeryDate} 
                                            onChange={(e) => setPatientInfo({...patientInfo, surgeryDate: e.target.value})} 
                                            className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-primary focus:outline-none transition-colors pr-10" 
                                        />
                                        <Calendar className="w-5 h-5 text-gray-400 absolute right-3 top-1/2 transform -translate-y-1/2" />
                                    </div>
                                </div>
                                <div className="md:col-span-2">
                                    <label className="block text-sm font-semibold text-gray-700 mb-2">‡∏ß‡∏±‡∏ô‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢ (Discharge)</label>
                                    <div className="relative">
                                        <input 
                                            type="date" 
                                            value={patientInfo.dischargeDate} 
                                            onChange={(e) => setPatientInfo({...patientInfo, dischargeDate: e.target.value})} 
                                            className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-primary focus:outline-none transition-colors pr-10" 
                                        />
                                        <Calendar className="w-5 h-5 text-gray-400 absolute right-3 top-1/2 transform -translate-y-1/2" />
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Complication Monitoring */}
                        <div className="bg-white rounded-2xl shadow-2xl p-6 mb-6">
                            <div className="flex items-center gap-2 mb-4 border-b pb-3">
                                <Thermometer className="w-6 h-6 text-danger" />
                                <h2 className="text-xl font-bold text-gray-800">üî¥ ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏†‡∏≤‡∏ß‡∏∞‡πÅ‡∏ó‡∏£‡∏Å‡∏ã‡πâ‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á</h2>
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                {/* DVT */}
                                <div 
                                    onClick={() => handleComplicationCheck('DVT')} 
                                    className={`flex items-center p-3 rounded-lg border-2 cursor-pointer transition-colors 
                                    ${complications.DVT ? 'bg-red-100 border-danger shadow-lg' : 'bg-gray-50 border-gray-200 hover:border-red-300'}`}
                                >
                                    <span className={`font-semibold ${complications.DVT ? 'text-danger' : 'text-gray-700'}`}>DVT (‡∏•‡∏¥‡πà‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏≠‡∏∏‡∏î‡∏ï‡∏±‡∏ô)</span>
                                    {complications.DVT ? <AlertCircle className="w-5 h-5 text-danger ml-auto" /> : <Square className="w-5 h-5 text-secondary ml-auto" />}
                                </div>
                                {/* Atelectasis */}
                                <div 
                                    onClick={() => handleComplicationCheck('Atelectasis')} 
                                    className={`flex items-center p-3 rounded-lg border-2 cursor-pointer transition-colors 
                                    ${complications.Atelectasis ? 'bg-red-100 border-danger shadow-lg' : 'bg-gray-50 border-gray-200 hover:border-red-300'}`}
                                >
                                    <span className={`font-semibold ${complications.Atelectasis ? 'text-danger' : 'text-gray-700'}`}>‡∏õ‡∏≠‡∏î‡πÅ‡∏ü‡∏ö/‡∏õ‡∏≠‡∏î‡∏≠‡∏±‡∏Å‡πÄ‡∏™‡∏ö</span>
                                    {complications.Atelectasis ? <AlertCircle className="w-5 h-5 text-danger ml-auto" /> : <Square className="w-5 h-5 text-secondary ml-auto" />}
                                </div>
                                {/* Constipation */}
                                <div 
                                    onClick={() => handleComplicationCheck('Constipation')} 
                                    className={`flex items-center p-3 rounded-lg border-2 cursor-pointer transition-colors 
                                    ${complications.Constipation ? 'bg-red-100 border-danger shadow-lg' : 'bg-gray-50 border-gray-200 hover:border-red-300'}`}
                                >
                                    <span className={`font-semibold ${complications.Constipation ? 'text-danger' : 'text-gray-700'}`}>‡∏ó‡πâ‡∏≠‡∏á‡∏ú‡∏π‡∏Å/‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Ç‡∏±‡∏ö‡∏ñ‡πà‡∏≤‡∏¢</span>
                                    {complications.Constipation ? <AlertCircle className="w-5 h-5 text-danger ml-auto" /> : <Square className="w-5 h-5 text-secondary ml-auto" />}
                                </div>
                            </div>
                            <label className="block text-sm font-semibold text-gray-700 mb-2 mt-4">‡∏≠‡∏≤‡∏Å‡∏≤‡∏£/‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏≠‡∏∑‡πà‡∏ô ‡πÜ:</label>
                            <textarea
                                value={complications.OtherSymptoms}
                                onChange={(e) => setComplications({...complications, OtherSymptoms: e.target.value})}
                                placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏≠‡∏∑‡πà‡∏ô ‡πÜ ‡πÄ‡∏ä‡πà‡∏ô ‡∏Ç‡πâ‡∏≠‡∏ï‡∏¥‡∏î, ‡πÅ‡∏ú‡∏•‡∏Å‡∏î‡∏ó‡∏±‡∏ö, ‡πÑ‡∏Ç‡πâ, ‡∏≠‡∏∑‡πà‡∏ô ‡πÜ"
                                rows="2"
                                className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-danger focus:outline-none transition-colors"
                            ></textarea>
                        </div>

                        {/* Export & Save Buttons */}
                        <div className="flex flex-col md:flex-row justify-end gap-3 mb-8 no-print">
                            {/* ‡∏õ‡∏∏‡πà‡∏°: ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏£‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà (Reset) */}
                            <button onClick={resetAssessment} className="flex items-center justify-center gap-2 px-6 py-3 rounded-xl font-semibold shadow-lg transition-all duration-300 bg-red-500 text-white hover:bg-red-600 hover:shadow-xl transform hover:scale-105">
                                <Trash2 className="w-5 h-5" />‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                            </button>
                            
                            {/* ‡∏õ‡∏∏‡πà‡∏°: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (Save/Update) - **‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ Google Sheet ‡πÉ‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ** */}
                            <button
                                onClick={saveCurrentPatient}
                                disabled={!isFormValid || isLoading}
                                className={`flex items-center justify-center gap-2 px-6 py-3 rounded-xl font-semibold shadow-lg transition-all duration-300 ${isFormValid && !isLoading ? 'bg-accent text-white hover:bg-amber-600' : 'bg-gray-300 text-gray-500 cursor-not-allowed'}`}
                            >
                                <Save className="w-5 h-5" />
                                ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å/‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï & ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                            </button>

                            {/* ‡∏õ‡∏∏‡πà‡∏°: ‡∏≠‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô PDF */}
                            <button onClick={generatePDF} disabled={!isFormValid} className={`flex items-center justify-center gap-2 px-6 py-3 rounded-xl font-semibold shadow-lg transition-all duration-300 ${isFormValid ? 'bg-success text-white hover:bg-green-600 hover:shadow-xl transform hover:scale-105' : 'bg-gray-300 text-gray-500 cursor-not-allowed'}`}>
                                <Download className="w-5 h-5" />‡∏≠‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô PDF
                            </button>
                        </div>
                        
                        {/* Day Selection Tabs */}
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-3 mb-8 no-print">
                            {Object.entries(assessmentData).map(([key, data]) => (
                                <button
                                    key={key}
                                    onClick={() => setSelectedDay(key)}
                                    className={`p-4 rounded-xl shadow-lg transition-all duration-300 transform hover:scale-105 ${selectedDay === key ? `bg-gradient-to-r ${data.color} text-white shadow-xl` : 'bg-white text-gray-700 hover:shadow-xl'}`}
                                >
                                    <div className="font-bold text-sm mb-1">{data.title}</div>
                                    <div className="text-xs opacity-90">{data.subtitle}</div>
                                </button>
                            ))}
                        </div>

                        {/* Assessment Card (Checklist) */}
                        <div className="bg-white rounded-2xl shadow-2xl overflow-hidden mb-6">
                            <div className={`bg-gradient-to-r ${currentAssessment.color} p-6 text-white`}>
                                <div className="flex items-center justify-between">
                                    <div>
                                        <h2 className="text-2xl font-bold mb-2">{currentAssessment.title}</h2>
                                        <p className="text-white/90">{currentAssessment.subtitle}</p>
                                    </div>
                                    <Clock className="w-12 h-12 opacity-80" />
                                </div>
                            </div>

                            {/* Checklist Items */}
                            <div className="p-6 space-y-3">
                                {currentAssessment.items.map((item, index) => (
                                    <div key={item.id} onClick={() => handleCheck(item.id)} className={`flex items-start gap-4 p-4 rounded-xl border-2 transition-all duration-300 cursor-pointer hover:shadow-md ${checkedItems[item.id] ? 'bg-green-50 border-success' : 'bg-gray-50 border-gray-200 hover:border-gray-300'}`}>
                                        <div className="flex-shrink-0 mt-1">
                                            {checkedItems[item.id] ? (<CheckSquare className="w-6 h-6 text-success" />) : (<Square className="w-6 h-6 text-secondary" />)}
                                        </div>
                                        <div className="flex-1">
                                            <div className="flex items-center gap-2 mb-1">
                                                <span className={`text-xs font-bold px-2 py-1 rounded ${checkedItems[item.id] ? 'bg-green-200 text-green-800' : 'bg-gray-200 text-gray-600'}`}>‡∏Ç‡πâ‡∏≠ {index + 1}</span>
                                            </div>
                                            <p className={`text-base leading-relaxed ${checkedItems[item.id] ? 'text-gray-700 font-medium' : 'text-gray-600'}`}>{item.text}</p>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ (‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å Google Sheet) */}
                        <div className="bg-white rounded-xl shadow-2xl p-6 mb-12 no-print">
                            <div className="flex items-center justify-between mb-4 border-b pb-3">
                                <div className="flex items-center gap-2">
                                    <Search className="w-6 h-6 text-purple-600" />
                                    <h3 className="text-xl font-bold text-gray-800">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ ({Object.keys(savedPatients).length} ‡∏£‡∏≤‡∏¢)</h3>
                                </div>
                                <button onClick={fetchPatientsFromSheet} disabled={isLoading} className="flex items-center gap-1 text-sm text-purple-600 hover:text-purple-800">
                                    <RefreshCw className={`w-4 h-4 ${isLoading ? 'animate-spin' : ''}`} />
                                    {isLoading ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...' : '‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î'}
                                </button>
                            </div>
                            
                            {Object.keys(savedPatients).length === 0 ? (
                                <p className="text-secondary text-center py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ</p>
                            ) : (
                                <div className="space-y-3 max-h-96 overflow-y-auto pr-2">
                                    {Object.keys(savedPatients).map((key) => {
                                        const patient = savedPatients[key];
                                        const totalItems = Object.values(assessmentData).reduce((sum, data) => sum + data.items.length, 0);
                                        const totalChecked = Object.values(assessmentData).reduce((sum, data) => sum + data.items.filter(item => patient.checks[item.id]).length, 0);
                                        const lastUpdateDate = new Date(patient.lastUpdate).toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' });
                                        
                                        return (
                                            <div key={key} className="flex flex-col md:flex-row items-start md:items-center justify-between p-4 bg-purple-50 rounded-lg border border-purple-200 hover:shadow-lg transition-shadow">
                                                <div className="flex-1 min-w-0 mb-2 md:mb-0">
                                                    <p className="text-lg font-semibold text-gray-800 truncate">
                                                        {patient.info.firstName} {patient.info.lastName} 
                                                        <span className="text-sm font-medium text-purple-600 ml-2">(AN: {key})</span>
                                                    </p>
                                                    <p className="text-xs text-gray-600 mt-1">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: {lastUpdateDate}</p>
                                                    <p className="text-xs text-gray-700 mt-1">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏£‡∏ß‡∏°: <span className="font-bold text-purple-700">{totalChecked}/{totalItems}</span></p>
                                                </div>
                                                <div className="flex gap-2 ml-0 md:ml-4 flex-shrink-0 w-full md:w-auto">
                                                    <button
                                                        onClick={() => loadPatient(key)}
                                                        className="flex items-center justify-center gap-1 px-3 py-2 bg-purple-500 text-white rounded-lg font-semibold text-sm hover:bg-purple-600 transition-colors shadow-md flex-1"
                                                    >
                                                        <Edit className="w-4 h-4" />‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                                                    </button>
                                                    
                                                    {/* ‡∏õ‡∏∏‡πà‡∏°: ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÑ‡∏õ Apps Script) */}
                                                    <button
                                                        onClick={() => deletePatient(key, `${patient.info.firstName} ${patient.info.lastName}`)}
                                                        className="flex items-center justify-center gap-1 px-3 py-2 bg-red-500 text-white rounded-lg font-semibold text-sm hover:bg-red-600 transition-colors shadow-md flex-1"
                                                    >
                                                        <Trash2 className="w-4 h-4" />‡∏•‡∏ö
                                                    </button>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            )}
                        </div>
                        
                    </div>
                </div>
            );
        }

        // Render Component ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà DOM
        const container = document.getElementById('root');
        const root = createRoot(container);
        root.render(<AmbulateAssessment />);
    </script>
</body>
</html>
