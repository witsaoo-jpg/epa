<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <title>แบบประเมิน Safety for Ambulate</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&family=Sukhumvit+Set:wght@400;700&display=swap');
    body { font-family: 'Sukhumvit Set', 'Kanit', sans-serif; }
    .hide-scrollbar::-webkit-scrollbar { display: none; }
    .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    .animate-fadeIn { animation: fadeIn 0.5s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .loading-overlay {
        position: absolute; top: 0; left: 0; right: 0; bottom: 0;
        background-color: rgba(255, 255, 255, 0.9);
        display: flex; align-items: center; justify-content: center;
        z-index: 50; border-radius: 0.75rem;
    }
  </style>
</head>
<body class="hide-scrollbar">

<div id="app" class="min-h-screen bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50 p-4">
  <div class="max-w-4xl mx-auto space-y-8 pb-12">
    
    <div class="text-center pt-8 animate-fadeIn">
      <div class="inline-flex items-center gap-4 mb-4">
        <i data-lucide="heart-pulse" class="w-12 h-12 text-pink-600"></i>
        <h1 class="text-5xl font-extrabold text-gray-900">Safety for Ambulate</h1>
      </div>
      <p class="text-gray-700 text-xl">แบบประเมินและฐานข้อมูลการเคลื่อนไหวของผู้ป่วย</p>
    </div>

    <div class="flex justify-center mb-6">
      <button id="modeAssess" onclick="setAppMode('assessment')" class="px-6 py-2 rounded-l-full font-semibold bg-blue-600 text-white shadow-md transition-all">
        <i data-lucide="clipboard-list" class="w-5 h-5 inline-block mr-2"></i> หน้าประเมิน
      </button>
      <button id="modeList" onclick="setAppMode('list')" class="px-6 py-2 rounded-r-full font-semibold bg-white text-gray-700 hover:bg-gray-100 transition-all">
        <i data-lucide="list-checks" class="w-5 h-5 inline-block mr-2"></i> รายการบันทึก
      </button>
    </div>

    <div id="assessmentView" class="animate-fadeIn space-y-8">
      <form id="assessmentForm" onsubmit="return false;">
        <div class="bg-white rounded-3xl shadow-xl p-8 border border-gray-100">
          <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-2"><i data-lucide="user" class="text-blue-600"></i> ข้อมูลผู้ป่วย</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <input type="text" id="firstName" placeholder="ชื่อจริง" class="input-field" required>
            <input type="text" id="lastName" placeholder="นามสกุล" class="input-field" required>
            <div class="flex gap-2">
                <input type="text" id="an" placeholder="รหัส AN" class="input-field" required>
                <button onclick="loadRecordByAN()" class="bg-purple-500 text-white rounded-xl px-4 hover:bg-purple-600"><i data-lucide="search"></i></button>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="text-sm text-gray-600">วันที่ผ่าตัด</label>
                    <input type="date" id="surgeryDate" class="input-field">
                </div>
                <div>
                    <label class="text-sm text-gray-600">วันที่จำหน่าย</label>
                    <input type="date" id="dischargeDate" class="input-field">
                </div>
            </div>
          </div>
        </div>
      </form>

      <div class="flex justify-between">
        <button onclick="resetForm()" class="px-5 py-2 rounded-xl bg-gray-200 text-gray-700 font-semibold hover:bg-gray-300"><i data-lucide="rotate-ccw" class="inline mr-1"></i> รีเซ็ต</button>
        <button id="submitButton" onclick="submitDataToSheet()" class="px-6 py-3 rounded-xl bg-blue-600 text-white font-bold shadow-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed">
            <i data-lucide="save" class="inline mr-1"></i> <span id="submitButtonText">บันทึกข้อมูล</span>
        </button>
      </div>

      <div id="dayTabs" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
      
      <div class="bg-white rounded-3xl shadow-xl overflow-hidden border border-gray-100">
        <div id="cardHeader" class="p-6 text-white bg-blue-500"></div>
        <div class="bg-gray-50 p-4">
             <div class="flex justify-between text-sm mb-1 font-bold text-gray-600"><span>ความคืบหน้า</span><span id="progressBarText">0%</span></div>
             <div class="w-full bg-gray-200 rounded-full h-2"><div id="progressBar" class="h-2 bg-blue-500 rounded-full" style="width: 0%"></div></div>
        </div>
        <div id="checklistItems" class="p-6 space-y-4"></div>
      </div>

      <div class="bg-white rounded-3xl shadow-xl p-6">
        <h3 class="font-bold text-gray-800 mb-4">สรุปผลการประเมิน</h3>
        <div id="summaryCard" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
      </div>
    </div>

    <div id="listView" class="hidden relative min-h-[300px]">
        <div id="listLoadingOverlay" class="loading-overlay hidden">
            <div class="text-center"><i data-lucide="loader-2" class="animate-spin w-8 h-8 text-blue-600 mx-auto"></i><p class="mt-2 text-gray-600">กำลังโหลดข้อมูล...</p></div>
        </div>
        <div class="bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden">
            <div class="bg-gray-100 p-4 font-bold text-gray-700 grid grid-cols-4 gap-2 text-sm">
                <div>AN</div><div class="col-span-2">ชื่อ-สกุล</div><div class="text-center">จัดการ</div>
            </div>
            <div id="recordsListContainer" class="divide-y divide-gray-100"></div>
        </div>
    </div>

  </div>
</div>

<script>
  // *** ใส่ URL ที่ได้จากการ Deploy ใหม่ ตรงนี้ ***
  const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwvmWLSVSCp3Sgy5LexLNNYyIMZUItfMh-hCGwdFXG-aEf_6c3U4wAdV1KnXtnv55tp/exec"; 

  tailwind.config = { theme: { extend: { colors: { 'gray-800': '#1f2937' } } } };
  
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.input-field').forEach(el => el.classList.add('w-full','px-4','py-2','border','border-gray-300','rounded-lg','focus:ring-2','focus:ring-blue-500','outline-none'));
    loadState();
    renderApp();
    document.getElementById('assessmentForm').addEventListener('input', () => { saveState(); renderBtn(); });
  });

  // Data & State
  let selectedDay = 'admission', checkedItems = {}, appMode = 'assessment';
  const assessmentData = {
    admission: { title: 'Admission Day', subtitle: 'วันที่รับผู้ป่วย', color: 'from-pink-500 to-pink-600', items: ['a1','a2','a3','a4','a5','a6'] },
    surgery: { title: 'วันที่ผ่าตัด', subtitle: 'หลัง OR', color: 'from-blue-500 to-blue-600', items: ['s1','s2','s3','s4'] },
    postop1: { title: 'Post Op Day 1', subtitle: 'หลังผ่าตัด 1 วัน', color: 'from-purple-500 to-purple-600', items: ['p1','p2','p3'] },
    postop2: { title: 'Post Op Day 2+', subtitle: '2 วันขึ้นไป', color: 'from-green-500 to-green-600', items: ['d1','d2','d3'] }
  };
  const itemsText = {
      'a1':'ให้ผู้ป่วยฝึก Ambulate', 'a2':'พลิกตะแคงตัวซ้าย ขวา ทุก 2 ชม.', 'a3':'นั่งหลังตรง 15 นาที', 'a4':'ตะแคงลุกนั่ง แกว่งขา 5 นาที', 'a5':'ยืนย่ำเท้า 10 ครั้ง', 'a6':'ลุกเดิน',
      's1':'หลังรับผู้ป่วยออกจาก OR', 's2':'พลิกตะแคงตัวซ้าย ขวา', 's3':'นั่งหลังตรง 15 นาที', 's4':'ตะแคงลุกนั่ง แกว่งขา',
      'p1':'นั่งแกว่งขา 5 นาที', 'p2':'ยืนย่ำเท้า 10 ครั้ง', 'p3':'เดิน > 40 เมตร',
      'd1':'นั่งแกว่งขา 5 นาที', 'd2':'ยืนย่ำเท้า 10 ครั้ง', 'd3':'เดิน > 60 เมตร'
  };

  // Core Functions
  function getPatientInfo() {
    return {
      firstName: document.getElementById('firstName').value,
      lastName: document.getElementById('lastName').value,
      an: document.getElementById('an').value,
      surgeryDate: document.getElementById('surgeryDate').value,
      dischargeDate: document.getElementById('dischargeDate').value
    };
  }
  
  function saveState() {
      localStorage.setItem('med_state', JSON.stringify({ day: selectedDay, checked: checkedItems, form: getPatientInfo() }));
  }
  function loadState() {
      const s = JSON.parse(localStorage.getItem('med_state'));
      if(s) {
          selectedDay = s.day || 'admission'; checkedItems = s.checked || {};
          if(s.form) {
             ['firstName','lastName','an','surgeryDate','dischargeDate'].forEach(k => document.getElementById(k).value = s.form[k]);
          }
      }
  }
  function resetForm() {
      if(!confirm('ล้างข้อมูลทั้งหมด?')) return;
      checkedItems = {}; localStorage.removeItem('med_state'); location.reload();
  }

  // Rendering
  function renderApp() {
    if(appMode === 'assessment') {
        const data = assessmentData[selectedDay];
        const total = data.items.length;
        const checked = data.items.filter(id => checkedItems[id]).length;
        const pct = Math.round((checked/total)*100) || 0;

        // Tabs
        document.getElementById('dayTabs').innerHTML = Object.keys(assessmentData).map(k => 
            `<button onclick="selectedDay='${k}';renderApp();" class="p-3 rounded-xl text-sm font-bold transition-all ${k===selectedDay ? 'bg-blue-600 text-white shadow-lg scale-105' : 'bg-white text-gray-600 hover:bg-gray-100'}">${assessmentData[k].title}</button>`
        ).join('');

        // Header & Progress
        document.getElementById('cardHeader').className = `p-6 text-white bg-gradient-to-r ${data.color}`;
        document.getElementById('cardHeader').innerHTML = `<h2 class="text-2xl font-bold">${data.title}</h2><p>${data.subtitle}</p>`;
        document.getElementById('progressBar').style.width = pct + '%';
        document.getElementById('progressBarText').innerText = pct + '%';

        // Items
        document.getElementById('checklistItems').innerHTML = data.items.map((id, i) => `
            <div onclick="toggleCheck('${id}')" class="flex items-center gap-3 p-3 rounded-lg border cursor-pointer transition-all ${checkedItems[id] ? 'bg-green-50 border-green-500' : 'hover:bg-gray-50'}">
                <div class="w-6 h-6 flex items-center justify-center rounded border ${checkedItems[id] ? 'bg-green-500 border-green-500 text-white' : 'border-gray-300'}">✓</div>
                <div class="flex-1"><span class="text-xs bg-gray-200 px-2 py-1 rounded mr-2">ข้อ ${i+1}</span>${itemsText[id]}</div>
            </div>
        `).join('');

        // Summary Small Cards
        document.getElementById('summaryCard').innerHTML = Object.keys(assessmentData).map(k => {
            const c = assessmentData[k].items.filter(id => checkedItems[id]).length;
            return `<div class="bg-gray-50 p-3 rounded-lg text-center"><div class="text-sm font-bold text-gray-600">${assessmentData[k].title}</div><div class="text-xl font-bold text-blue-600">${c}/${assessmentData[k].items.length}</div></div>`
        }).join('');

        renderBtn();
    }
    lucide.createIcons();
  }

  function toggleCheck(id) { checkedItems[id] = !checkedItems[id]; saveState(); renderApp(); }
  function renderBtn() {
      const valid = document.getElementById('firstName').value && document.getElementById('an').value;
      const btn = document.getElementById('submitButton');
      btn.disabled = !valid;
      document.getElementById('submitButtonText').innerText = valid ? "บันทึกข้อมูล" : "กรอกชื่อและ AN";
  }

  function setAppMode(m) {
      appMode = m;
      document.getElementById('assessmentView').classList.toggle('hidden', m !== 'assessment');
      document.getElementById('listView').classList.toggle('hidden', m !== 'list');
      if(m === 'list') loadRecordsList();
  }

  // --- API CONNECTIONS (FETCH ONLY) ---

  // 1. Save Data
  function submitDataToSheet() {
      Swal.fire({ title: 'กำลังบันทึก...', didOpen: () => Swal.showLoading() });
      const payload = { action: 'save', patientInfo: getPatientInfo(), checkedItems: checkedItems };
      
      fetch(WEB_APP_URL, { method: "POST", body: JSON.stringify(payload) })
      .then(r => r.json())
      .then(res => {
          if(res.status === 'success') Swal.fire('สำเร็จ', 'บันทึกข้อมูลแล้ว', 'success').then(() => generatePDF());
          else Swal.fire('Error', res.message, 'error');
      })
      .catch(e => Swal.fire('Error', 'Connection failed', 'error'));
  }

  // 2. Load List
  function loadRecordsList() {
      const loader = document.getElementById('listLoadingOverlay');
      const container = document.getElementById('recordsListContainer');
      loader.classList.remove('hidden');
      
      // ใช้ POST action: 'getAll' แทน google.script.run
      fetch(WEB_APP_URL, { method: "POST", body: JSON.stringify({ action: 'getAll' }) })
      .then(r => r.json())
      .then(records => {
          loader.classList.add('hidden');
          if(!Array.isArray(records) || records.length === 0) {
              container.innerHTML = '<div class="p-4 text-center text-gray-500">ไม่พบข้อมูล</div>'; return;
          }
          container.innerHTML = records.map(r => `
            <div class="grid grid-cols-4 gap-2 p-4 items-center hover:bg-gray-50 text-sm">
                <div class="font-bold text-purple-700 truncate">${r.an}</div>
                <div class="col-span-2 truncate">${r.name}<br><span class="text-xs text-gray-400">ออก: ${r.dischargeDate}</span></div>
                <div class="flex justify-center gap-1">
                    <button onclick="loadRecordByAN('${r.an}')" class="bg-blue-100 text-blue-600 p-2 rounded hover:bg-blue-200"><i data-lucide="edit" class="w-4 h-4"></i></button>
                    <button onclick="deleteRecord('${r.an}')" class="bg-red-100 text-red-600 p-2 rounded hover:bg-red-200"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                </div>
            </div>
          `).join('');
          lucide.createIcons();
      })
      .catch(e => { loader.classList.add('hidden'); container.innerHTML = '<div class="text-red-500 p-4 text-center">โหลดข้อมูลไม่สำเร็จ</div>'; });
  }

  // 3. Load One Record
  function loadRecordByAN(anInput) {
      const an = anInput || document.getElementById('an').value;
      if(!an) return Swal.fire('แจ้งเตือน', 'กรุณาระบุ AN', 'warning');

      Swal.fire({ title: 'กำลังค้นหา...', didOpen: () => Swal.showLoading() });

      fetch(WEB_APP_URL, { method: "POST", body: JSON.stringify({ action: 'getOne', an: an }) })
      .then(r => r.json())
      .then(res => {
          if(res.status === 'success') {
              const d = res.data;
              document.getElementById('firstName').value = d.firstName;
              document.getElementById('lastName').value = d.lastName;
              document.getElementById('an').value = d.an;
              document.getElementById('surgeryDate').value = d.surgeryDate;
              document.getElementById('dischargeDate').value = d.dischargeDate;
              checkedItems = d.checkedItems;
              
              setAppMode('assessment');
              renderApp();
              Swal.close();
          } else {
              Swal.fire('ไม่พบข้อมูล', 'ไม่มี AN นี้ในระบบ', 'error');
          }
      })
      .catch(e => Swal.fire('Error', 'Connection failed', 'error'));
  }

  // 4. Delete
  function deleteRecord(an) {
      Swal.fire({ title: 'ยืนยันลบ?', text: `ลบข้อมูล AN: ${an}`, icon: 'warning', showCancelButton: true, confirmButtonText: 'ลบ' })
      .then(r => {
          if(r.isConfirmed) {
              Swal.fire({ title: 'กำลังลบ...', didOpen: () => Swal.showLoading() });
              fetch(WEB_APP_URL, { method: "POST", body: JSON.stringify({ action: 'delete', an: an }) })
              .then(r => r.json())
              .then(res => {
                  if(res.status === 'success') {
                      Swal.fire('เรียบร้อย', 'ลบข้อมูลแล้ว', 'success');
                      loadRecordsList();
                  } else Swal.fire('Error', res.message, 'error');
              });
          }
      });
  }

  // PDF Gen (Simplified)
  function generatePDF() {
      const p = getPatientInfo();
      const win = window.open('', '_blank', 'width=800,height=600');
      win.document.write(`<html><body style="font-family:sans-serif;padding:40px;">
        <h1 style="color:#2563eb;text-align:center;border-bottom:2px solid #eee;padding-bottom:10px;">ผลการประเมิน Safety for Ambulate</h1>
        <p><b>ชื่อ:</b> ${p.firstName} ${p.lastName} <b>AN:</b> ${p.an}</p>
        <p><b>วันที่ผ่าตัด:</b> ${p.surgeryDate} <b>วันที่จำหน่าย:</b> ${p.dischargeDate}</p>
        <hr>
        ${Object.keys(assessmentData).map(k => {
            const d = assessmentData[k];
            const c = d.items.filter(i => checkedItems[i]).length;
            return `<div style="margin-top:20px;"><h3 style="background:#f3f4f6;padding:10px;">${d.title} (${Math.round(c/d.items.length*100)}%)</h3>
            <ul style="list-style:none;padding:0;">${d.items.map(i => `<li style="padding:5px;color:${checkedItems[i]?'green':'#ccc'}">${checkedItems[i]?'☑':'☐'} ${itemsText[i]}</li>`).join('')}</ul></div>`;
        }).join('')}
      </body></html>`);
      setTimeout(() => { win.print(); win.close(); }, 500);
  }
</script>

</body>
</html>
